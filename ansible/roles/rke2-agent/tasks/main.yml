---
  - name: Include common RKE2 tasks
    ansible.builtin.include_role:
      name: rke2-common

  - name: Check if RKE2 is already installed
    ansible.builtin.stat:
      path: /usr/local/bin/rke2
    register: rke2_binary

  - name: Set first server flag (always false for agents)
    ansible.builtin.set_fact:
      rke2_is_first_server: false

  - name: Set node type
    ansible.builtin.set_fact:
      rke2_node_type: "agent"

  - name: Deploy RKE2 agent config
    ansible.builtin.template:
      src: ../rke2-common/templates/config.yaml.j2
      dest: /etc/rancher/rke2/config.yaml
      mode: "0600"
    notify: Restart rke2-agent

  - name: Install RKE2 agent
    ansible.builtin.shell: |
      curl -sfL https://get.rke2.io | \
        INSTALL_RKE2_VERSION={{ rke2_version }} \
        INSTALL_RKE2_TYPE=agent \
        INSTALL_RKE2_CHANNEL={{ rke2_channel }} \
        INSTALL_RKE2_METHOD=tar sh -
    args:
      creates: /usr/local/bin/rke2
    when: not rke2_binary.stat.exists

  - name: Enable rke2-agent service
    ansible.builtin.systemd:
      name: rke2-agent
      enabled: true

  - name: Start rke2-agent service
    ansible.builtin.systemd:
      name: rke2-agent
      state: started

  - name: Wait for agent to start
    ansible.builtin.wait_for:
      timeout: 30
